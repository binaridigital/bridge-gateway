name: CD â€” Dev

on:
  push:
    branches: [dev]

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  VAULT_ADDR:      ${{ secrets.VAULT_ADDR }}
  HARBOR_REGISTRY: harbor.binari.digital
  HARBOR_PROJECT:  bridge-gateway
  IMAGE_NAME:      bridge-gateway
  JAVA_VERSION:    '17'

jobs:

  build-push:
    name: Build & Push to Harbor
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: Build application
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      - name: Compute version
        id: meta
        run: |
          SHA="${GITHUB_SHA::8}"
          TAG="dev-${SHA}"
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Normalize Vault address
        run: |
          ADDR="${{ secrets.VAULT_ADDR }}"
          [[ "$ADDR" =~ ^https?:// ]] || ADDR="https://$ADDR"
          echo "VAULT_ADDR=$ADDR" >> $GITHUB_ENV

      - name: Get Harbor credentials from Vault
        id: vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: github-bridge-gateway-dev
          jwtGithubAudience: https://github.com/binaridigital
          secrets: |
            kv/cicd/harbor/bridge-gateway/data/harbor-registry username | HARBOR_USERNAME ;
            kv/cicd/harbor/bridge-gateway/data/harbor-registry password | HARBOR_PASSWORD ;

      - name: Docker login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_REGISTRY }}
          username: ${{ steps.vault.outputs.HARBOR_USERNAME }}
          password: ${{ steps.vault.outputs.HARBOR_PASSWORD }}

      - uses: docker/setup-buildx-action@v3

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:dev-latest
          build-args: |
            BUILD_VERSION=${{ steps.meta.outputs.image_tag }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        env:
          TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          echo "## Dev Build \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ env.IMAGE_NAME }} | \`${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${TAG}\` |" >> $GITHUB_STEP_SUMMARY

  open-pr-to-stage:
    name: Open PR dev -> stage
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG:      ${{ needs.build-push.outputs.image_tag }}
        run: |
          EXISTING=$(gh pr list --base stage --head dev --state open \
            --json number -q '.[0].number' 2>/dev/null || echo "")
          BODY="## Dev -> Stage

          **Build:** \`${TAG}\`
          **Commit:** \`${{ github.sha }}\`
          **Author:** ${{ github.actor }}

          | Image | Tag |
          |-------|-----|
          | ${{ env.IMAGE_NAME }} | \`${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${TAG}\` |

          Review, approve and merge to deploy to **staging**."

          if [ -n "$EXISTING" ]; then
            gh pr edit "$EXISTING" --title "chore: dev -> stage [${TAG}]" --body "$BODY"
            echo "Updated PR #${EXISTING}"
          else
            gh pr create --base stage --head dev \
              --title "chore: dev -> stage [${TAG}]" \
              --body "$BODY" --label "deployment" || true
            echo "Opened PR dev -> stage"
          fi
